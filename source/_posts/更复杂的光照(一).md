---
title: 更复杂的光照(一)
date: 2022-02-17 11:31:37
tags: Light
categories: Unity Shader
---

## Unity 的渲染路径 ##

在 Unity 里，**渲染路径(Rendering Path)**决定光照是如何运用到 Unity Shader 中的。我们需要为每个 Pass 指定它使用的渲染路径，只有这样才能让 Unity 正确地为我们准备光源和处理后的光照信息等数据，也就是说，我们只有为 Shader 正确地选择和设置了需要的渲染路径，该 Shader 的光照计算才能被正确执行。

Unity 支持多种类型的渲染路径。**前向渲染路径(Forward Rendering Path)**、**延迟渲染路径(Deferred Rendering Path)**和**顶点照明渲染路径(Vertex Lit Rendering Path)**。顶点照明渲染路径已经被 Unity 抛弃，新的延迟渲染路径代替了原来的延迟渲染路径(但目前仍然可以对之前使用了顶点照明渲染路径和旧的延迟渲染路径的 Unity Shader 兼容)。

大多数情况下，一个项目只用一种渲染路径，因此我们可以通过在 Unity 的 Edit -> Project Settings -> Graphics -> Tier Settings -> Rendering Path 中选择项目所需的渲染路径。默认情况下该设置选择的都是前向渲染路径。但有时我们希望使用多个渲染路径，如不同的摄像机使用不同的渲染路径，这时我们可以在摄像机的渲染路径设置中进行设置，以覆盖 Project Settings 中的设置。如果当前显卡不支持所选择的渲染路径，Unity 会自动使用更低一级的渲染路径。例如，如果一个 GPU 不支持延迟渲染，那么 Unity 就会使用前向渲染。

完成上面的设置后，我们就可以在每个 Pass 中使用 **LightMode** 标签来指定该 Pass 使用的渲染路径。

```shaderlab
Tags { "LightMode" = "ForwardBase" }
```

上面的代码将告诉 Unity，该 Pass 使用前向渲染路径中的 **ForwardBase** 路径。而前向渲染路径还有一种路径叫 **ForwardAdd**。下表给出了 Pass 的 LightMode 标签支持的渲染路径设置选项。

| 标签名                           | 描述                                                                               |
| :------------------------------- | :--------------------------------------------------------------------------------- |
| Always                           | 不管使用哪种渲染路径，该 Pass 总是会被渲染，但不会计算任何光照                     |
| ForwardBase                      | 用于**前向渲染**。该 Pass 会计算环境光、最重要的平行光、逐顶点/SH 光源和 Lightmaps |
| ForwardAdd                       | 用于**前向渲染**。该 Pass 会计算额外的逐像素光源，每个 Pass 对应一个光源           |
| Deferred                         | 用于**延迟渲染**。该 Pass 会渲染 G 缓冲(G-buffer)                                  |
| ShadowCaster                     | 把物体的深度信息渲染到阴影映射纹理(shadowmap)或一张深度纹理中                      |
| PrepassBase                      | 用于**遗留的延迟渲染**。该 Pass 会渲染法线和高光反射的指数部分                     |
| PrepassFinal                     | 用于**遗留的延迟渲染**。该 Pass 通过合并纹理、光照和自发光来渲染得到最后的颜色     |
| Vertex、VertexLMRGBM 和 VertexLM | 用于**遗留的顶点照明渲染**。                                                       |

指定渲染路径是我们和 Unity 底层渲染引擎的一次重要的沟通。例如，如果我们为一个 Pass 设置了前向渲染路径的标签，Unity 会把那些光照属性都按前向渲染的流程准备好，我们就可以通过 Unity 提供的内置光照变量来访问这些属性。如果我们没有指定任何渲染路径，那么一些光照变量很可能不会被正确赋值，我们计算出的效果也就很有可能是错误的。

#### 前向渲染路径 ####

###### 1. 前向渲染路径的原理 ######

每进行一次完整的前向渲染，我们需要渲染该对象的渲染图元，并计算两个缓冲区的信息：一个是颜色缓冲区，一个是深度缓冲区。我们利用深度缓冲来决定一个片元是否可见，如果可见就更新颜色缓冲区中的颜色值。我们可以利用下面的伪代码来描述前向渲染路径的大致过程：

、、、shaderlab
Pass {
    for (each primitive in this model) {
        for (each fragment covered by this primitive) {
            if (failed in depth test) {
                //如果没有通过深度测试，说明该片元是不可见的
                discard;
            } else {
                //如果该片元可见，就进行光照计算
                float4 color = Shading(materialInfo, pos, normal, lightDir, viewDir);
                //更新帧缓冲
                writeFrameBuffer(fragment, color);
            }
        }
    }
}
、、、

对于每个逐像素光源，我们都需要进行上面一次完整的渲染流程。如果一个物体在多个逐像素光源的影响区域内，那么该物体就需要执行多个 Pass，每个 Pass 计算一个逐像素光源的光照结果，然后在帧缓冲中把这些光照结果混合起来得到最终的颜色值。假设，场景中有 N 个物体，每个物体受 M 个光源的影响，那么需要渲染整个场景一共需要 N * M 个 Pass。可以看出，如果有大量逐像素光照，那么需要执行的 Pass 数目也会很大。因此，渲染引擎通常会限制每个物体的逐像素光照的数目。

###### 2. Unity 中的前向渲染 ######

一个 Pass 不仅仅可以用来计算逐像素光照，也可以计算逐顶点等其他光照。这取决于光照计算所处流水线阶段以及计算时使用的数学模型。当我们渲染一个物体时，Unity 会计算哪些光源照亮了它以及这些光源照亮该物体的方式。

在 Unity 中，前向渲染路径有 3 种处理光照(即照亮物体)的方式：**逐顶点处理、逐像素处理、球谐函数(Spherical Harmonics, SH)处理**。而决定一个光源使用哪种处理模式取决于它的类型和渲染模式。光源类型指的是该光源是平行光还是其他类型的光源，而光源的渲染模式指的是该光源是否是**重要的(Important)**。如果一个光照的模式被设置为 Important，Unity就会把它当成一个逐像素光源来处理。我们可以在光源的 Light 组件中设置这些属性，如下图所示。

![Light 组件](/posts_image/MoreComplexLighting/MoreComplexLighting_1.png "Light 组件")

在前向渲染中，当我们渲染一个物体时，Unity 会根据场景中各个光源的设置以及这些光源对物体的影响程度(例如，距离该物体的远近、光源强度等)对这些光源进行一个重要度排序。其中，一定数目的光源会按逐像素的方式处理，然后最多有 4 个光源按逐顶点的方式处理，剩下的光源可以按 SH 方式处理。Unity 使用的判断规则如下。

* 场景中最亮的平行光总是按逐像素处理的。
* 渲染模式被设置成 Not Important 的光源，会按逐顶点或者 SH 处理。
* 渲染模式被设置成 Important 的光源，会按逐像素处理。
* 如果根据以上规则得到的逐像素光源数量小于 Quality Setting 中的逐像素光源数量(Pixel Light Count)，会有更多的光源以逐像素的方式进行渲染。
  
光照计算都在 Pass 里进行。前向渲染有两种 Pass：Base Pass 和 Additional Pass。通常来说，这两种 Pass 进行的标签和渲染设置以及常规光照计算如下图所示。

![前向渲染的两种Pass](/posts_image/MoreComplexLighting/MoreComplexLighting_2.png "前向渲染的两种Pass")